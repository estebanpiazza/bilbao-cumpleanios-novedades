<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cumpleaños, Novedades y Reflexión</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Estilo para el video cuando se muestra */
    .video-container {
      width: 100%;
      height: 450px;
      display: none;
    }

    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    /* Estilos para la lista de eventos */
    #eventos-lista {
      list-style-type: none;
      padding: 0;
    }
    
    #eventos-lista li {
      background-color: #f8f9fa;
      border-left: 4px solid #007bff;
      margin-bottom: 10px;
      padding: 12px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #eventos-lista li:hover {
      background-color: #e9ecef;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Cabecera con el logo -->
  <div class="header">
    <img src="./limerik-logo.png" alt="Logo Colegio Limerick">
    <h1>Colegio Limerick</h1>
  </div>

  <!-- Título principal -->
  <h1 style="text-align: center;">Cumpleaños, Novedades y Reflexión del Día</h1>

  <!-- Fecha y Hora -->
  <div class="fecha-hora" id="fecha-hora"></div>
  
  <!-- Botón para actualizar manualmente -->
  <div style="text-align: center; margin: 10px 0; position:fixed;bottom:0;right:0;">
    <button onclick="cargarDatos(true)" style="padding: 5px 10px;">Actualizar Datos</button>
  </div>

  <!-- Pregunta de Reflexión -->
  <div class="container">
    <div class="reflexion" id="reflexion">
      <!-- Aquí se mostrará la pregunta de reflexión -->
    </div>
  </div>
  <div class="container">
    
    <!-- Columna de Cumpleaños -->
    <div class="column">
      <h2>Cumpleaños</h2>
      <ul id="cumpleaños-lista">
        <!-- Aquí se mostrarán los cumpleaños -->
      </ul>
    </div>

    <!-- Columna de Eventos -->
    <div class="column">
      <h2>Eventos</h2>
      
      <!-- Contenedor para el video especial -->
      <div id="video-container" class="video-container">
        <video autoplay loop muted>
          <source src="./video.mp4" type="video/mp4">
          Tu navegador no soporta videos.
        </video>
      </div>

      <!-- Lista de eventos del día -->
      <ul id="eventos-lista">
        <!-- Aquí se mostrarán las novedades -->
      </ul>
    </div>
  </div>

  <script>
    // Función para verificar si es la fecha especial y mostrar el video
    function verificarFechaEspecial() {
      const hoy = new Date();
      const esFechaEspecial = hoy.getDate() === 23 && 
                              hoy.getMonth() === 5 && // Junio es el mes 5 (0-indexado)
                              hoy.getFullYear() === 2025;
      
      const videoContainer = document.getElementById('video-container');
      const eventosLista = document.getElementById('eventos-lista');
      
      if (esFechaEspecial) {
        // Si es la fecha especial, ocultar eventos y mostrar video
        eventosLista.style.display = 'none';
        videoContainer.style.display = 'block';
        // Asegurarse de que el video se reproduce
        const video = videoContainer.querySelector('video');
        if (video) {
          video.play();
        }
      } else {
        // Si no es la fecha especial, mostrar eventos y ocultar video
        eventosLista.style.display = 'block';
        videoContainer.style.display = 'none';
      }
    }

    // Función para cargar eventos desde Google Sheets
    async function cargarEventosGoogleSheets() {
      try {
        // URL de la hoja de cálculo en formato CSV
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/1_O6rKb1-g_hxGD-9bP1h2-RLbIZjWjfUYa6h3nBHKPg/export?format=csv&gid=387666732';
        
        const response = await fetch(sheetUrl);
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const csvText = await response.text();
        const lines = csvText.split('\n');
        
        // Omitir la primera línea (encabezados)
        const dataLines = lines.slice(1);
        
        const eventos = [];
        const hoy = new Date();
        const fechaHoy = `${hoy.getDate()}/${hoy.getMonth() + 1}/${hoy.getFullYear()}`;
        
        dataLines.forEach(line => {
          if (line.trim() === '') return; // Saltar líneas vacías
          
          // Parsear CSV (considerando comas dentro de comillas)
          const cols = [];
          let current = '';
          let inQuotes = false;
          
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              cols.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          cols.push(current); // Agregar la última columna
          
          if (cols.length >= 12) {
            const evento = {
              nombre: cols[2]?.replace(/"/g, '').trim() || '',
              fechaInicio: cols[3]?.replace(/"/g, '').trim() || '',
              horaInicio: cols[4]?.replace(/"/g, '').trim() || '',
              fechaFin: cols[5]?.replace(/"/g, '').trim() || '',
              horaFin: cols[6]?.replace(/"/g, '').trim() || '',
              nivel: cols[7]?.replace(/"/g, '').trim() || '',
              curso: cols[8]?.replace(/"/g, '').trim() || '',
              lugar: cols[9]?.replace(/"/g, '').trim() || '',
              conFamilia: cols[10]?.replace(/"/g, '').trim() || '',
              urlEvento: cols[11]?.replace(/"/g, '').trim() || ''
            };
            
            // Verificar si el evento es para hoy
            if (evento.fechaInicio === fechaHoy) {
              eventos.push(evento);
            }
          }
        });
        
        return eventos;
        
      } catch (error) {
        console.error('Error cargando eventos desde Google Sheets:', error);
        return [];
      }
    }

    // Función para cargar el archivo JSON y actualizar el contenido
    async function cargarDatos(forzarRecarga = false) {
      try {
        // Verificar si es la fecha especial para mostrar el video
        verificarFechaEspecial();
        
        // Añadir un parámetro de tiempo para evitar la caché del navegador si se fuerza la recarga
        const cacheBuster = forzarRecarga ? `?t=${new Date().getTime()}` : '';
        const response = await fetch('datos.json' + cacheBuster);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const datos = await response.json();
        const hoy = new Date(); // Fecha de hoy
        const añoActual = hoy.getFullYear(); // Obtener el año actual
        
        // Formatear la fecha actual como YYYY-MM-DD para comparar con el JSON
        const fechaHoyFormato = hoy.toISOString().split('T')[0];

        // Función para verificar si un cumpleaños coincide con la fecha
        function coincideCumpleaños(cumple, fecha) {
          if (!cumple.fecha) return false; // Evitar errores si no hay fecha
          
          const [añoCumple, mesCumple, diaCumple] = cumple.fecha.split('-').map(Number);
          
          if (cumple.tipo === "alumno" && cumple.egreso >= añoActual) {
            // Si es alumno y el año de egreso es mayor o igual que el actual
            return fecha.getMonth() + 1 === mesCumple && fecha.getDate() === diaCumple;
          } else if (cumple.tipo === "profesor") {
            // Si es profesor, comparar solo día y mes sin validar egreso
            return fecha.getMonth() + 1 === mesCumple && fecha.getDate() === diaCumple;
          }

          return false;
        }

        // Filtrar los cumpleaños
        let cumpleañosDeHoy = datos.cumpleaños.filter(cumple => 
          coincideCumpleaños(cumple, hoy)
        );

        // Si es viernes, agregar cumpleaños de sábado y domingo
        if (hoy.getDay() === 5) { // 5 representa viernes
          const sabado = new Date(hoy);
          sabado.setDate(hoy.getDate() + 1);
          
          const domingo = new Date(hoy);
          domingo.setDate(hoy.getDate() + 2);
          
          const cumpleañosSabadoDomingo = datos.cumpleaños.filter(cumple => 
            coincideCumpleaños(cumple, sabado) || 
            coincideCumpleaños(cumple, domingo)
          );

          cumpleañosDeHoy = [...cumpleañosDeHoy, ...cumpleañosSabadoDomingo];
        }

        // Filtrar la pregunta de reflexión que coincide con la fecha de hoy
        const reflexionDeHoy = datos.preguntas_reflexion.find(pregunta => {
          return pregunta.fecha === fechaHoyFormato;
        });

        // Cargar eventos desde Google Sheets
        const eventosDeHoy = await cargarEventosGoogleSheets();

        // Limpiar las listas previas
        const cumpleañosLista = document.getElementById('cumpleaños-lista');
        const eventosLista = document.getElementById('eventos-lista');
        const reflexionDiv = document.getElementById('reflexion');
        cumpleañosLista.innerHTML = '';
        eventosLista.innerHTML = '';
        reflexionDiv.innerHTML = '';

        // Mostrar los cumpleaños
        if (cumpleañosDeHoy.length > 0) {
          cumpleañosDeHoy.forEach(item => {
            const li = document.createElement('li');
            
            // Si es viernes, mostrar el día del cumpleaños
            if (hoy.getDay() === 5) {
              const [, mes, dia] = item.fecha.split('-');
              const fechaCumple = new Date(añoActual, mes - 1, dia);
              
              // Determinar si es cumpleaños de hoy, sábado o domingo
              let diaCumple;
              if (coincideCumpleaños(item, hoy)) {
                diaCumple = 'hoy';
              } else if (fechaCumple.getDay() === 6) {
                diaCumple = 'sábado';
              } else if (fechaCumple.getDay() === 0) {
                diaCumple = 'domingo';
              }
              
              li.textContent = `${item.nombre} (Cumpleaños ${diaCumple})`;
            } else {
              li.textContent = item.nombre;
            }
            
            cumpleañosLista.appendChild(li);
          });
        } else {
          cumpleañosLista.innerHTML = '<li>No hay cumpleaños hoy</li>';
        }

        // Mostrar los eventos del día
        if (eventosDeHoy.length > 0) {
          eventosDeHoy.forEach(evento => {
            const li = document.createElement('li');
            li.innerHTML = `
              <strong>${evento.nombre}</strong><br>
              <span style="font-size: 0.9em; color: #666;">
                ${evento.horaInicio} - ${evento.horaFin}<br>
                ${evento.nivel} ${evento.curso ? '- ' + evento.curso : ''}<br>
                ${evento.lugar ? 'Lugar: ' + evento.lugar : ''}
                ${evento.conFamilia === 'Sí' ? ' (Con familia)' : ''}
              </span>
            `;
            eventosLista.appendChild(li);
          });
        }

        // Mostrar las novedades del día (si existen)
        if (datos.novedades && datos.novedades.length > 0) {
          const novedadesDelDia = datos.novedades.filter(novedad => novedad.fecha === fechaHoyFormato);
          
          if (novedadesDelDia.length > 0) {
            novedadesDelDia.forEach(novedad => {
              const li = document.createElement('li');
              
              if (novedad.imagen) {
                // Si hay una imagen, mostrarla sin título
                li.innerHTML = `
                  <img src="./${novedad.imagen}" alt="${novedad.nombre}" style="width: 100%; max-width: 400px; margin-top: 10px; border-radius: 4px;">
                `;
              } else {
                // Si no hay imagen, mostrar solo el nombre
                li.textContent = novedad.nombre;
              }
              
              eventosLista.appendChild(li);
            });
          } else if (eventosDeHoy.length === 0) {
            // Solo mostrar "No hay eventos" si no hay ni eventos de Google Sheets ni novedades
            eventosLista.innerHTML = '<li>No hay eventos programados para hoy</li>';
          }
        } else if (eventosDeHoy.length === 0) {
          // Solo mostrar "No hay eventos" si no hay eventos de Google Sheets
          eventosLista.innerHTML = '<li>No hay eventos programados para hoy</li>';
        }

        // Mostrar la pregunta de reflexión del día
        if (reflexionDeHoy) {
          reflexionDiv.textContent = `Pregunta de Reflexión: ${reflexionDeHoy.pregunta}`;
        } else {
          reflexionDiv.textContent = 'No hay pregunta de reflexión para hoy.';
        }

        console.log('Datos cargados correctamente:', {
          fecha: fechaHoyFormato,
          cumpleaños: cumpleañosDeHoy.length,
          eventos: eventosDeHoy.length,
          reflexion: reflexionDeHoy ? 'Disponible' : 'No disponible'
        });
        
      } catch (error) {
        console.error('Error cargando el archivo JSON:', error);
      }
    }

    // Función para mostrar la fecha y hora actual en tiempo real
    function actualizarFechaHora() {
      const ahora = new Date();
      const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const fecha = ahora.toLocaleDateString('es-ES', opciones);
      const hora = ahora.toLocaleTimeString('es-ES');
      document.getElementById('fecha-hora').innerHTML = `${fecha} - ${hora}`;
      
      // Verificar si es la fecha especial cada vez que se actualiza la hora
      verificarFechaEspecial();
    }

    // Verificar si cambió el día desde la última carga
    let diaActual = new Date().getDate();
    function verificarCambioDeDia() {
      const ahora = new Date();
      if (diaActual !== ahora.getDate()) {
        diaActual = ahora.getDate();
        cargarDatos(true); // Forzar recarga de datos al cambiar de día
        console.log('Cambio de día detectado - Datos recargados');
      }
    }

    // Función que verifica la hora y recarga los datos cada hora y a las 7:00 AM
    function verificarHoraParaActualizar() {
      const ahora = new Date();
      const horaActual = ahora.getHours();
      const minutosActuales = ahora.getMinutes();

      // Verificamos si es una hora en punto para actualizar
      if (minutosActuales === 0) {
        cargarDatos(true);
        console.log('Actualización programada a la hora en punto');
      }
      
      // Verificamos si es exactamente las 7:00 AM para actualizar
      if (horaActual === 7 && minutosActuales === 0) {
        window.location.reload(); // Recargar la página completa a las 7 AM
      }

      // Verificar si cambiamos de día
      verificarCambioDeDia();
    }

    // Iniciar la página cargando los datos y actualizando la hora
    window.onload = function() {
      cargarDatos(); // Carga inicial de datos
      actualizarFechaHora(); // Actualiza la fecha y hora inicial
      verificarFechaEspecial(); // Verificar si hay que mostrar el video
      
      // Programar actualizaciones automáticas
      setInterval(actualizarFechaHora, 1000); // Actualiza la hora cada segundo
      setInterval(verificarHoraParaActualizar, 60000); // Verifica cada minuto si debe actualizar datos
      setInterval(() => cargarDatos(true), 3600000); // Fuerza una actualización cada hora (3600000 ms)
    };
  </script>
</body>
</html>